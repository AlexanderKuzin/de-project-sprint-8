Привет!
Для улучшения читаемости разбил код на отдельные функции, исправил ошибку с определением метки текущего времени на верхнем уровне (завел новую колонку для фильтрации данных в датафрейме).